#!/usr/bin/perl

# This script is unsupported. Use at your own risk.

# ./configula  --alogin=cryptodbwww --adb=cryp120n --udb=apicomm q1.cryptodb.org

# Wrapper on eupathSiteConfigure
# see eupathSiteConfigure details at
# https://docs.google.com/a/apidb.org/document/d/1zy_HMf7BFf2L2ZhHHIr1K2GuTbQXJx1JdnoDOl_4OHE/
# This script
#   - autogenerates the metaConfig file for eupathSiteConfigure.
#   - validates the required properties in metaConfig file against sample
#     - fails if either missing or extraneous properties are found
#   - bootstraps many values from EuPathDB's file and directory naming conventions

# This script is rated 'chmod +x'

use strict;
use File::Basename;
use POSIX qw(strftime);
use lib "$ENV{'GUS_HOME'}/lib/perl";
use EuPathSiteCommon::Model::Configula;

my ($this) = basename $0;

my $emc = EuPathSiteCommon::Model::Configula->new({
  'modelName' => 'apiCommonModel',
});

my $content = <<"EOF";
# Generated by $this on @{[ strftime("%m/%d/%Y at %H:%M", localtime) ]}

required:
 project: $emc->{'product'}

 appDb.instance: $emc->{'appDb_database'}
 appDb.login: $emc->{'appDb_login'}
 appDb.password: $emc->{'appDb_password'}
 appDB.userDbLink:  @{[ $emc->dblink($emc->{'userDb_database'}) ]}

 userDb.instance: $emc->{'userDb_database'}
 userDb.login: $emc->{'userDb_login'}
 userDb.password: $emc->{'userDb_password'}

 commentDb.instance: $emc->{'userDb_database'}
 commentDb.login: $emc->{'userDb_login'}
 commentDb.password: $emc->{'userDb_password'}
 gushome: $emc->{'gus_home'}

 plasmoPubsURL: 'http://v4-4.plasmodb.org/publications/publications-v5.php?uid=28&gid='
 
 eupaURL: http://$emc->{'host_class_prefix'}eupathdb.org/eupathdb/
 orthURL: http://$emc->{'host_class_prefix'}orthomcl.org/orthomcl/
 amebURL: http://$emc->{'host_class_prefix'}amoebadb.org/amoeba/
 crypURL: http://$emc->{'host_class_prefix'}cryptodb.org/cryptodb/
 fungURL: http://$emc->{'host_class_prefix'}fungidb.org/fungidb/
 giarURL: http://$emc->{'host_class_prefix'}giardiadb.org/giardiadb/
 micrURL: http://$emc->{'host_class_prefix'}microsporidiadb.org/micro/
 piroURL: http://$emc->{'host_class_prefix'}piroplasmadb.org/piro/
 plasURL: http://$emc->{'host_class_prefix'}plasmodb.org/plasmo/
 toxoURL: http://$emc->{'host_class_prefix'}toxodb.org/toxo/
 tricURL: http://$emc->{'host_class_prefix'}trichdb.org/trichdb/
 trypURL: http://$emc->{'host_class_prefix'}tritrypdb.org/tritrypdb/

sections:
 - apiSite
 - @{[ lc $emc->{'product'} ]}
EOF

$emc->write_meta_config($content);

####################################################################
# Do It!
####################################################################

my $sample = "$emc->{'gus_home'}/lib/yaml/metaConfig.yaml.sample";

$emc->validate_meta_config($sample, $emc->{'meta_config_file'});

$emc->do_configure($emc->{'product'}, $emc->{'meta_config_file'});

